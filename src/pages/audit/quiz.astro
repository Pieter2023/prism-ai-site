---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout
  title="AI Business Audit ‚Äî Assessment | Prism AI"
  description="Complete your AI Business Audit assessment."
>
  <section class="quiz-section">
    <div class="container quiz-container">
      <div class="quiz-header">
        <div class="hero-badge">AI Business Audit</div>
        <h1>Your AI Readiness Assessment</h1>
        <p>Answer each question as honestly as possible. There are no right or wrong answers ‚Äî the more detail you give, the better your report will be. Takes 15‚Äì20 minutes.</p>
        <div class="progress-bar-wrap">
          <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
        <p class="progress-label" id="progress-label">Step 1 of 6</p>
      </div>

      <form id="audit-form">
        <!-- STEP 1: About You -->
        <div class="quiz-step active" id="step-1">
          <h2 class="step-title">About You & Your Business</h2>
          <div class="field-group">
            <label>Your full name *</label>
            <input type="text" name="name" required placeholder="e.g. Jane Smith" />
          </div>
          <div class="field-group">
            <label>Company name *</label>
            <input type="text" name="company" required placeholder="e.g. Acme Corp" />
          </div>
          <div class="field-group">
            <label>Your email address *</label>
            <input type="email" name="email" required placeholder="e.g. jane@acme.com" />
          </div>
          <div class="field-group">
            <label>Your role / title *</label>
            <input type="text" name="role" required placeholder="e.g. Operations Manager, CEO" />
          </div>
          <div class="field-group">
            <label>Industry *</label>
            <select name="industry" required>
              <option value="">Select your industry</option>
              <option>Real Estate</option>
              <option>Property Management</option>
              <option>Marketing / Agency</option>
              <option>Legal</option>
              <option>Healthcare</option>
              <option>Financial Services</option>
              <option>Retail / E-commerce</option>
              <option>Construction / Trades</option>
              <option>Hospitality</option>
              <option>Professional Services</option>
              <option>Technology</option>
              <option>Other</option>
            </select>
          </div>
          <div class="field-group">
            <label>Team size *</label>
            <select name="team_size" required>
              <option value="">Select team size</option>
              <option>Solo (just me)</option>
              <option>2‚Äì5 people</option>
              <option>6‚Äì15 people</option>
              <option>16‚Äì50 people</option>
              <option>50+ people</option>
            </select>
          </div>
        </div>

        <!-- STEP 2: Current Operations -->
        <div class="quiz-step" id="step-2">
          <h2 class="step-title">Your Current Operations</h2>
          <div class="field-group">
            <label>What does your business do? (1‚Äì2 sentences) *</label>
            <textarea name="business_description" required rows="3" placeholder="e.g. We manage 200+ rental properties across the Greater Vancouver area for landlords..."></textarea>
          </div>
          <div class="field-group">
            <label>What are your top 3 most time-consuming manual tasks? *</label>
            <textarea name="manual_tasks" required rows="4" placeholder="e.g. 1. Manually entering leads into CRM&#10;2. Chasing overdue invoices by phone&#10;3. Building weekly reports in Excel..."></textarea>
          </div>
          <div class="field-group">
            <label>How many hours per week does your team spend on these manual tasks? *</label>
            <select name="manual_hours" required>
              <option value="">Select an estimate</option>
              <option>Less than 5 hours</option>
              <option>5‚Äì10 hours</option>
              <option>10‚Äì20 hours</option>
              <option>20‚Äì40 hours</option>
              <option>More than 40 hours</option>
            </select>
          </div>
          <div class="field-group">
            <label>What's the biggest operational bottleneck in your business right now? *</label>
            <textarea name="bottleneck" required rows="3" placeholder="e.g. Lead follow-up falls through the cracks when we're busy ‚Äî we lose deals we should be closing..."></textarea>
          </div>
        </div>

        <!-- STEP 3: Tech Stack -->
        <div class="quiz-step" id="step-3">
          <h2 class="step-title">Your Technology Stack</h2>
          <div class="field-group">
            <label>What CRM or customer management tool do you use? *</label>
            <input type="text" name="crm" required placeholder="e.g. HubSpot, Salesforce, spreadsheet, none" />
          </div>
          <div class="field-group">
            <label>What tools do you use for communication? (select all that apply)</label>
            <div class="checkbox-group">
              <label class="checkbox-item"><input type="checkbox" name="comms" value="Email (Gmail/Outlook)" /> Email (Gmail/Outlook)</label>
              <label class="checkbox-item"><input type="checkbox" name="comms" value="Slack" /> Slack</label>
              <label class="checkbox-item"><input type="checkbox" name="comms" value="WhatsApp" /> WhatsApp</label>
              <label class="checkbox-item"><input type="checkbox" name="comms" value="Microsoft Teams" /> Microsoft Teams</label>
              <label class="checkbox-item"><input type="checkbox" name="comms" value="Phone calls only" /> Phone calls only</label>
            </div>
          </div>
          <div class="field-group">
            <label>What do you use for project/task management?</label>
            <input type="text" name="task_mgmt" placeholder="e.g. Asana, Monday.com, spreadsheets, nothing formal" />
          </div>
          <div class="field-group">
            <label>What accounting / invoicing software do you use?</label>
            <input type="text" name="accounting" placeholder="e.g. QuickBooks, Xero, Wave, manual" />
          </div>
          <div class="field-group">
            <label>How comfortable is your team with adopting new technology? *</label>
            <select name="tech_comfort" required>
              <option value="">Select an option</option>
              <option>Very comfortable ‚Äî we adopt new tools easily</option>
              <option>Somewhat comfortable ‚Äî with proper training</option>
              <option>Neutral ‚Äî depends on the tool</option>
              <option>Resistant ‚Äî team prefers familiar ways</option>
              <option>Very resistant ‚Äî change is a major challenge</option>
            </select>
          </div>
        </div>

        <!-- STEP 4: AI Readiness -->
        <div class="quiz-step" id="step-4">
          <h2 class="step-title">Your AI Readiness</h2>
          <div class="field-group">
            <label>Have you used any AI tools in your business? *</label>
            <select name="ai_experience" required>
              <option value="">Select an option</option>
              <option>Yes ‚Äî actively using AI tools (e.g. ChatGPT, Copilot, etc.)</option>
              <option>Experimenting ‚Äî tried a few things</option>
              <option>No ‚Äî but curious and ready to start</option>
              <option>No ‚Äî and skeptical about AI</option>
            </select>
          </div>
          <div class="field-group">
            <label>If you've used AI tools, which ones? (leave blank if none)</label>
            <input type="text" name="ai_tools_used" placeholder="e.g. ChatGPT, Zapier AI, Copilot, Midjourney..." />
          </div>
          <div class="field-group">
            <label>What's your biggest concern about implementing AI in your business?</label>
            <select name="ai_concern">
              <option value="">Select your main concern</option>
              <option>Cost ‚Äî not sure if the ROI is there</option>
              <option>Complexity ‚Äî worried it will be too hard to implement</option>
              <option>Trust ‚Äî not sure AI outputs can be relied on</option>
              <option>Data privacy ‚Äî worried about sensitive data</option>
              <option>Team adoption ‚Äî staff resistance</option>
              <option>I don't have major concerns</option>
            </select>
          </div>
          <div class="field-group">
            <label>What would success look like for you 6 months after implementing AI? *</label>
            <textarea name="success_vision" required rows="3" placeholder="e.g. My team spends less time on admin, leads are followed up automatically, and I have a live dashboard showing pipeline health without building it manually each week..."></textarea>
          </div>
        </div>

        <!-- STEP 5: Goals & Budget -->
        <div class="quiz-step" id="step-5">
          <h2 class="step-title">Goals & Investment</h2>
          <div class="field-group">
            <label>Which area would you most like to improve? *</label>
            <select name="priority_area" required>
              <option value="">Select your priority</option>
              <option>Lead generation & follow-up</option>
              <option>Operations & workflow automation</option>
              <option>Reporting & business intelligence</option>
              <option>Customer communication & support</option>
              <option>Team productivity & internal tools</option>
              <option>All of the above equally</option>
            </select>
          </div>
          <div class="field-group">
            <label>Do you have a timeline or urgency for improvement? *</label>
            <select name="timeline" required>
              <option value="">Select an option</option>
              <option>Urgent ‚Äî I need to fix this in the next 30 days</option>
              <option>Soon ‚Äî within the next 3 months</option>
              <option>Planning ahead ‚Äî 3‚Äì6 months</option>
              <option>Exploring ‚Äî no firm timeline yet</option>
            </select>
          </div>
          <div class="field-group">
            <label>What budget range are you considering for AI implementation? *</label>
            <select name="budget" required>
              <option value="">Select a range</option>
              <option>Under $5,000 CAD</option>
              <option>$5,000 ‚Äì $15,000 CAD</option>
              <option>$15,000 ‚Äì $30,000 CAD</option>
              <option>$30,000 ‚Äì $60,000 CAD</option>
              <option>$60,000+ CAD</option>
              <option>Not sure yet</option>
            </select>
          </div>
          <div class="field-group">
            <label>Is there anything else you'd like Prism AI to know about your situation?</label>
            <textarea name="additional_info" rows="4" placeholder="Any context, constraints, prior experiences, or specific requirements that would help us tailor your report..."></textarea>
          </div>
        </div>

        <!-- STEP 6: Review & Submit -->
        <div class="quiz-step" id="step-6">
          <h2 class="step-title">Almost Done!</h2>
          <p class="step-desc">Review your details below. Your personalized AI Readiness Report will be prepared within 48 hours and we'll reach out to schedule your strategy call.</p>
          <div class="review-box" id="review-box">
            <!-- filled by JS -->
          </div>
          <div class="field-group">
            <label class="checkbox-item consent-check">
              <input type="checkbox" name="consent" required />
              I agree that Prism AI may use my responses to prepare my report and contact me regarding my assessment. I understand my data will not be shared with third parties.
            </label>
          </div>
        </div>

        <!-- Navigation -->
        <div class="quiz-nav">
          <button type="button" class="btn-secondary" id="btn-prev" style="display:none" onclick="prevStep()">‚Üê Back</button>
          <button type="button" class="btn-primary" id="btn-next" onclick="nextStep()">Continue ‚Üí</button>
          <button type="submit" class="btn-primary" id="btn-submit" style="display:none">Submit My Assessment ‚úì</button>
        </div>
      </form>

      <!-- Success state -->
      <div id="quiz-success" style="display:none" class="success-card">
        <div class="success-icon">üéâ</div>
        <h2>Assessment Submitted!</h2>
        <p>Thank you ‚Äî your AI Readiness Report is being prepared. You'll hear from the Prism AI team within 48 hours to share your report and schedule your strategy call.</p>
        <p class="success-email">Check your inbox at <strong id="success-email-display"></strong></p>
        <a href="/" class="btn-secondary" style="margin-top:1.5rem;display:inline-block">Back to Prism AI ‚Üí</a>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  const TOTAL_STEPS = 6;
  let currentStep = 1;

  function updateProgress() {
    const pct = ((currentStep - 1) / (TOTAL_STEPS - 1)) * 100;
    document.getElementById('progress-bar').style.width = pct + '%';
    document.getElementById('progress-label').textContent = `Step ${currentStep} of ${TOTAL_STEPS}`;
    document.getElementById('btn-prev').style.display = currentStep > 1 ? 'inline-flex' : 'none';
    document.getElementById('btn-next').style.display = currentStep < TOTAL_STEPS ? 'inline-flex' : 'none';
    document.getElementById('btn-submit').style.display = currentStep === TOTAL_STEPS ? 'inline-flex' : 'none';
    if (currentStep === TOTAL_STEPS) buildReview();
  }

  function buildReview() {
    const form = document.getElementById('audit-form');
    const data = new FormData(form);
    const fields = [
      ['Name', data.get('name')],
      ['Company', data.get('company')],
      ['Email', data.get('email')],
      ['Role', data.get('role')],
      ['Industry', data.get('industry')],
      ['Team size', data.get('team_size')],
      ['Priority area', data.get('priority_area')],
      ['Timeline', data.get('timeline')],
      ['Budget', data.get('budget')],
    ];
    const html = fields.filter(([,v]) => v).map(([k,v]) =>
      `<div class="review-row"><span class="review-key">${k}</span><span class="review-val">${v}</span></div>`
    ).join('');
    document.getElementById('review-box').innerHTML = html;
  }

  function validateStep(step) {
    const stepEl = document.getElementById(`step-${step}`);
    const required = stepEl.querySelectorAll('[required]');
    for (const el of required) {
      if (!el.value || (el.type === 'checkbox' && !el.checked)) {
        el.focus();
        el.classList.add('error');
        setTimeout(() => el.classList.remove('error'), 2000);
        return false;
      }
    }
    return true;
  }

  function nextStep() {
    if (!validateStep(currentStep)) return;
    document.getElementById(`step-${currentStep}`).classList.remove('active');
    currentStep++;
    document.getElementById(`step-${currentStep}`).classList.add('active');
    updateProgress();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function prevStep() {
    document.getElementById(`step-${currentStep}`).classList.remove('active');
    currentStep--;
    document.getElementById(`step-${currentStep}`).classList.add('active');
    updateProgress();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  document.getElementById('audit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const data = new FormData(form);
    const payload = Object.fromEntries(data.entries());

    // Collect checkboxes
    const comms = [...form.querySelectorAll('input[name="comms"]:checked')].map(el => el.value);
    payload.comms = comms.join(', ');

    document.getElementById('btn-submit').textContent = 'Submitting...';
    document.getElementById('btn-submit').disabled = true;

    try {
      const res = await fetch('/api/audit-submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        form.style.display = 'none';
        document.querySelector('.quiz-header').style.display = 'none';
        const successEl = document.getElementById('quiz-success');
        successEl.style.display = 'block';
        document.getElementById('success-email-display').textContent = payload.email;
      } else {
        throw new Error('Submission failed');
      }
    } catch (err) {
      document.getElementById('btn-submit').textContent = 'Submit My Assessment ‚úì';
      document.getElementById('btn-submit').disabled = false;
      alert('Something went wrong. Please try again or email us at admin@prismaiservices.com');
    }
  });
</script>

<style>
.quiz-section { padding: 4rem 0 6rem; min-height: 80vh; }
.quiz-container { max-width: 680px; margin: 0 auto; }
.quiz-header { text-align: center; margin-bottom: 3rem; }
.quiz-header h1 { font-size: 2rem; margin: 1rem 0; }
.quiz-header p { color: var(--color-text-muted); line-height: 1.6; margin-bottom: 1.5rem; }
.hero-badge {
  display: inline-block;
  padding: 0.4rem 1rem;
  background: rgba(108, 60, 225, 0.12);
  border: 1px solid rgba(108, 60, 225, 0.3);
  border-radius: 999px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--color-primary-light);
}
.progress-bar-wrap {
  height: 6px;
  background: var(--color-border);
  border-radius: 999px;
  overflow: hidden;
  margin: 1rem 0 0.5rem;
}
.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
  border-radius: 999px;
  transition: width 0.3s ease;
}
.progress-label { font-size: 0.85rem; color: var(--color-text-muted); }
.quiz-step { display: none; }
.quiz-step.active { display: block; }
.step-title { font-size: 1.5rem; margin-bottom: 2rem; }
.step-desc { color: var(--color-text-muted); margin-bottom: 2rem; line-height: 1.6; }
.field-group { margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
.field-group label { font-weight: 600; font-size: 0.95rem; }
.field-group input, .field-group select, .field-group textarea {
  padding: 0.75rem 1rem;
  border: 1px solid var(--color-border);
  border-radius: 8px;
  background: var(--color-bg-card);
  color: var(--color-text-heading);
  font-size: 0.95rem;
  font-family: inherit;
  transition: border-color 0.2s;
}
.field-group input:focus, .field-group select:focus, .field-group textarea:focus {
  outline: none;
  border-color: var(--color-primary-light);
}
.field-group input.error, .field-group select.error, .field-group textarea.error {
  border-color: #ef4444;
}
.checkbox-group { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.25rem; }
.checkbox-item { display: flex; align-items: center; gap: 0.75rem; font-weight: 400; cursor: pointer; }
.checkbox-item input { width: 18px; height: 18px; cursor: pointer; }
.consent-check { font-weight: 400; font-size: 0.9rem; color: var(--color-text-muted); align-items: flex-start; }
.quiz-nav { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--color-border); }
.review-box { background: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
.review-row { display: flex; gap: 1rem; font-size: 0.9rem; }
.review-key { font-weight: 600; min-width: 140px; color: var(--color-text-muted); }
.review-val { color: var(--color-text-heading); }
.success-card { text-align: center; padding: 4rem 2rem; }
.success-icon { font-size: 4rem; margin-bottom: 1rem; }
.success-card h2 { font-size: 1.75rem; margin-bottom: 1rem; }
.success-card p { color: var(--color-text-muted); line-height: 1.6; max-width: 480px; margin: 0 auto 1rem; }
.success-email { font-size: 0.95rem; }
</style>

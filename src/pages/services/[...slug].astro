---
/**
 * Dynamic pSEO page template.
 * Generates one page per row in the "pSEO Matrix" Google Sheet.
 * Uses [...slug] catch-all to support flat slugs like:
 *   /services/ai-workflow-automation-real-estate-kelowna
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import Hero from '../../components/Hero.astro';
import FAQ from '../../components/FAQ.astro';
import JsonLd from '../../components/JsonLd.astro';
import { getPseoEntries, getContentBlock, type PseoEntry } from '../../lib/sheets';

export async function getStaticPaths() {
  const entries = await getPseoEntries();
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

interface Props {
  entry: PseoEntry;
}

const { entry } = Astro.props;

// Fetch matching content blocks for industry and location context
const industryBlock = await getContentBlock('industry_desc', entry.industry.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, ''));
const locationSlug = entry.location.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
const locationBlock = await getContentBlock('location_ctx', locationSlug);
const serviceSlug = entry.head_term.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
const serviceBlock = await getContentBlock('service_desc', serviceSlug);

// Build FAQ items
const faqItems = [];
if (entry.faq_1_q && entry.faq_1_a) faqItems.push({ question: entry.faq_1_q, answer: entry.faq_1_a });
if (entry.faq_2_q && entry.faq_2_a) faqItems.push({ question: entry.faq_2_q, answer: entry.faq_2_a });
if (entry.faq_3_q && entry.faq_3_a) faqItems.push({ question: entry.faq_3_q, answer: entry.faq_3_a });

// Build JSON-LD
const siteUrl = 'https://prismaiservices.netlify.app';
const pageUrl = `${siteUrl}/services/${entry.slug}`;
const jsonLd = {
  '@context': 'https://schema.org',
  '@graph': [
    {
      '@type': 'Service',
      '@id': pageUrl,
      name: entry.hero_headline,
      description: entry.meta_description,
      provider: {
        '@type': 'LocalBusiness',
        name: 'Prism AI Services',
        url: siteUrl,
        address: {
          '@type': 'PostalAddress',
          addressLocality: entry.location.split(',')[0]?.trim(),
          addressRegion: entry.location.split(',')[1]?.trim() || '',
          addressCountry: 'CA',
        },
      },
      areaServed: { '@type': 'Place', name: entry.location },
      serviceType: entry.head_term,
      category: entry.industry,
    },
    ...(faqItems.length > 0 ? [{
      '@type': 'FAQPage',
      mainEntity: faqItems.map(f => ({
        '@type': 'Question',
        name: f.question,
        acceptedAnswer: { '@type': 'Answer', text: f.answer },
      })),
    }] : []),
    {
      '@type': 'BreadcrumbList',
      itemListElement: [
        { '@type': 'ListItem', position: 1, name: 'Home', item: siteUrl },
        { '@type': 'ListItem', position: 2, name: 'Services', item: `${siteUrl}/services` },
        { '@type': 'ListItem', position: 3, name: entry.hero_headline, item: pageUrl },
      ],
    },
  ],
};
---

<BaseLayout
  title={entry.meta_title}
  description={entry.meta_description}
  canonical={pageUrl}
  jsonLd={jsonLd}
>
  <!-- Breadcrumb -->
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <div class="container">
      <a href="/">Home</a>
      <span>/</span>
      <a href="/#services">Services</a>
      <span>/</span>
      <span class="current">{entry.head_term} for {entry.industry}</span>
    </div>
  </nav>

  <!-- Hero Section (BLUF: Bottom Line Up Front) -->
  <Hero
    headline={entry.hero_headline}
    subline={entry.hero_subline}
    statValue={entry.stat_value}
    statLabel={entry.stat_label}
    ctaText={entry.cta_text}
  />

  <!-- Pain Point Section -->
  <section class="pain-section">
    <div class="container">
      <div class="pain-grid">
        <div class="pain-content">
          <h2>The Challenge Facing {entry.industry} in {entry.location}</h2>
          <p class="pain-text">{entry.pain_point}</p>
          {industryBlock && (
            <p class="industry-context">{industryBlock.block_content}</p>
          )}
        </div>
        <div class="pain-visual">
          <div class="pain-card">
            <div class="pain-icon">&#x26A0;</div>
            <p>Without automation, {entry.industry.toLowerCase()} businesses lose an average of 15+ hours per week on manual tasks.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Solution Section -->
  <section class="solution-section" id="solution">
    <div class="container">
      <h2>How Prism AI Solves This</h2>
      <div class="solution-content">
        <p class="solution-main">{entry.solution_paragraph}</p>
        {serviceBlock && (
          <div class="service-detail card">
            <h3>{serviceBlock.block_title}</h3>
            <p>{serviceBlock.block_content}</p>
          </div>
        )}
      </div>

      {entry.integration && (
        <div class="integration-badge">
          <h3>Seamless Integration</h3>
          <div class="integration-tags">
            {entry.integration.split('/').map((tool) => (
              <span class="tag">{tool.trim()}</span>
            ))}
          </div>
        </div>
      )}
    </div>
  </section>

  <!-- Location Context -->
  {locationBlock && (
    <section class="location-section">
      <div class="container">
        <div class="location-card card">
          <h2>Serving {entry.location}</h2>
          <p>{locationBlock.block_content}</p>
        </div>
      </div>
    </section>
  )}

  <!-- FAQ Section -->
  {faqItems.length > 0 && (
    <FAQ items={faqItems} heading={`${entry.head_term} FAQ for ${entry.industry}`} />
  )}

  <!-- CTA Section -->
  <section class="cta-section" id="contact">
    <div class="container">
      <div class="cta-card">
        <h2>Ready to Transform Your {entry.industry} Business?</h2>
        <p>Get a free consultation and see how AI can save your team 15+ hours per week.</p>
        <a href="#talk-to-ai" class="btn-primary" onclick="if(window.startAICall){event.preventDefault();startAICall();}">{entry.cta_text}</a>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .breadcrumb {
    padding: 1rem 0;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }
  .breadcrumb a { color: var(--color-text-muted); }
  .breadcrumb a:hover { color: var(--color-primary-light); }
  .breadcrumb span { margin: 0 0.5rem; }
  .breadcrumb .current { color: var(--color-text); }

  .pain-section { background: var(--color-bg-card); }
  .pain-grid {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 3rem;
    align-items: center;
  }
  .pain-content h2 {
    font-size: 1.75rem;
    margin-bottom: 1.25rem;
  }
  .pain-text {
    font-size: 1.1rem;
    line-height: 1.8;
    margin-bottom: 1.25rem;
  }
  .industry-context {
    color: var(--color-text-muted);
    font-size: 0.95rem;
    line-height: 1.8;
    border-left: 3px solid var(--color-primary);
    padding-left: 1rem;
  }
  .pain-card {
    background: rgba(245, 158, 11, 0.08);
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: var(--radius);
    padding: 2rem;
    text-align: center;
  }
  .pain-icon { font-size: 2.5rem; margin-bottom: 1rem; }

  .solution-section h2 {
    font-size: 2rem;
    text-align: center;
    margin-bottom: 2rem;
  }
  .solution-main {
    font-size: 1.1rem;
    line-height: 1.8;
    max-width: 800px;
    margin: 0 auto 2rem;
    text-align: center;
  }
  .service-detail {
    max-width: 700px;
    margin: 0 auto;
  }
  .service-detail h3 {
    font-size: 1.25rem;
    margin-bottom: 0.75rem;
    color: var(--color-primary-light);
  }

  .integration-badge {
    text-align: center;
    margin-top: 3rem;
  }
  .integration-badge h3 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--color-text-muted);
  }
  .integration-tags {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }
  .tag {
    padding: 0.5rem 1rem;
    background: rgba(6, 182, 212, 0.1);
    border: 1px solid rgba(6, 182, 212, 0.25);
    border-radius: 999px;
    font-size: 0.9rem;
    color: var(--color-secondary);
    font-weight: 500;
  }

  .location-section .location-card {
    max-width: 800px;
    margin: 0 auto;
    text-align: center;
  }
  .location-card h2 {
    margin-bottom: 1rem;
  }

  .cta-section {
    padding: 5rem 0;
  }
  .cta-card {
    text-align: center;
    background: linear-gradient(135deg, rgba(108, 60, 225, 0.15), rgba(6, 182, 212, 0.1));
    border: 1px solid rgba(108, 60, 225, 0.3);
    border-radius: var(--radius);
    padding: 4rem 2rem;
  }
  .cta-card h2 {
    font-size: 2rem;
    margin-bottom: 1rem;
  }
  .cta-card p {
    color: var(--color-text-muted);
    margin-bottom: 2rem;
    font-size: 1.1rem;
  }

  @media (max-width: 768px) {
    .pain-grid { grid-template-columns: 1fr; }
  }
</style>
